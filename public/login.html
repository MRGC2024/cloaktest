<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Cloaker Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f0f23; color: #fff; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .card { background: #16213e; border: 1px solid #2a2a4a; border-radius: 20px; padding: 40px; max-width: 400px; width: 100%; }
    .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 30px; }
    .logo i { font-size: 36px; color: #e94560; }
    .logo h1 { font-size: 24px; font-weight: 600; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; color: #a0a0b0; font-size: 14px; }
    .form-input { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid #2a2a4a; background: #1a1a2e; color: #fff; font-size: 14px; }
    .form-input:focus { outline: none; border-color: #e94560; }
    .btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #e94560, #ff6b6b); color: white; margin-top: 10px; }
    .btn:hover { opacity: 0.9; }
    .msg { margin-top: 15px; padding: 10px; border-radius: 8px; font-size: 13px; display: none; }
    .msg.error { background: rgba(220,53,69,0.2); color: #dc3545; display: block; }
    .msg.success { background: rgba(0,217,165,0.2); color: #00d9a5; display: block; }
    #setupBox { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #2a2a4a; }
    .setup-title { font-size: 14px; color: #a0a0b0; margin-bottom: 15px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">
      <i class="ri-shield-keyhole-fill"></i>
      <h1>Cloaker Pro</h1>
    </div>
    <form id="loginForm">
      <div class="form-group">
        <label class="form-label">Usuário</label>
        <input type="text" class="form-input" id="username" name="username" required autocomplete="username">
      </div>
      <div class="form-group">
        <label class="form-label">Senha</label>
        <input type="password" class="form-input" id="password" name="password" required autocomplete="current-password">
      </div>
      <button type="submit" class="btn"><i class="ri-login-box-line"></i> Entrar</button>
      <div id="loginMsg" class="msg"></div>
    </form>
    <div id="setupBox">
      <div class="setup-title">Primeiro acesso? Crie o usuário administrador:</div>
      <form id="setupForm">
        <div class="form-group">
          <label class="form-label">Usuário (admin)</label>
          <input type="text" class="form-input" id="setupUsername" required minlength="2">
        </div>
        <div class="form-group">
          <label class="form-label">Senha (mín. 6 caracteres)</label>
          <input type="password" class="form-input" id="setupPassword" required minlength="6">
        </div>
        <button type="submit" class="btn"><i class="ri-user-add-line"></i> Criar administrador</button>
        <div id="setupMsg" class="msg"></div>
      </form>
    </div>
  </div>
  <script>
    var loginMsg = document.getElementById('loginMsg');
    var setupBox = document.getElementById('setupBox');
    var setupMsg = document.getElementById('setupMsg');

    fetch('/api/me', { credentials: 'include' }).then(function(r) {
      if (r.ok) { window.location.href = '/'; return; }
      return fetch('/api/setup/check', { credentials: 'include' }).then(function(r2) { return r2.ok ? r2.json() : {}; });
    }).then(function(data) {
      if (data && data.setupRequired) setupBox.style.display = 'block';
    });

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      loginMsg.className = 'msg'; loginMsg.textContent = '';
      var form = e.target;
      fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username: form.username.value.trim(), password: form.password.value })
      }).then(function(r) {
        return r.json().then(function(data) {
          if (r.ok) { window.location.href = '/'; return; }
          loginMsg.className = 'msg error'; loginMsg.textContent = data.error || 'Erro ao entrar';
        });
      }).catch(function() { loginMsg.className = 'msg error'; loginMsg.textContent = 'Erro de conexão'; });
    });

    document.getElementById('setupForm').addEventListener('submit', function(e) {
      e.preventDefault();
      setupMsg.className = 'msg'; setupMsg.textContent = '';
      var form = e.target;
      fetch('/api/setup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username: form.setupUsername.value.trim(), password: form.setupPassword.value })
      }).then(function(r) {
        return r.json().then(function(data) {
          if (r.ok) { window.location.href = '/'; return; }
          setupMsg.className = 'msg error'; setupMsg.textContent = data.error || 'Erro ao criar';
        });
      }).catch(function() { setupMsg.className = 'msg error'; setupMsg.textContent = 'Erro de conexão'; });
    });

      </script>
</body>
</html>
